<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kids Chore Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f0e6;
      margin: 0;
      padding: 0;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    .tab {
      background: #386641;
      color: white;
      padding: 10px;
      border-radius: 8px 8px 0 0;
      margin: 0 5px;
      cursor: pointer;
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 50px; /* match table row height */
      position: relative;
    }
    .tab.active {
      background: #6a994e;
    }
    .rank-bubble {
      background: #bc4749;
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      margin-right: 8px;
    }
    .table-container {
      overflow-x: auto;
      padding: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
      min-width: 800px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th:first-child, td:first-child {
      text-align: left;
      width: 120px;
    }
    .total-row {
      font-weight: bold;
      background-color: #eee;
    }
    .current-day {
      background-color: #d5e3d0 !important;
    }
    .icon {
      font-size: 18px;
      display: block;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="tabs" id="tabs"></div>
  <div class="table-container">
    <table id="choreTable"></table>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAO_SS5Q1SDNTq9wK5B7bTyp5nhPT5Pf84",
      authDomain: "chores-18a66.firebaseapp.com",
      projectId: "chores-18a66",
      storageBucket: "chores-18a66.firebasestorage.app",
      messagingSenderId: "785602926667",
      appId: "1:785602926667:web:f87426009cc83bc77095ce",
      measurementId: "G-DELL5N4DTG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const kids = ["Ryan", "Jack", "Henry", "Sonny"];
    const chores = [
      { key: "shower", icon: "ðŸš¿" },
      { key: "teeth", icon: "ðŸ¦·" },
      { key: "bedroom", icon: "ðŸ›ï¸" },
      { key: "clothes", icon: "ðŸ‘•" },
      { key: "other", icon: "ðŸ“¦" },
      { key: "deduction", icon: "âž–" },
      { key: "reading", icon: "ðŸ“š" },
      { key: "practice", icon: "ðŸŽ»" },
      { key: "workout", icon: "ðŸ’ª" }
    ];
    const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    let currentKid = kids[0];
    let data = {};

    function renderTabs() {
      const tabsDiv = document.getElementById("tabs");
      tabsDiv.innerHTML = "";
      kids.forEach(kid => {
        const tab = document.createElement("div");
        tab.className = "tab" + (kid === currentKid ? " active" : "");
        const rankBubble = document.createElement("div");
        rankBubble.className = "rank-bubble";
        rankBubble.textContent = 0;
        const nameSpan = document.createElement("span");
        nameSpan.textContent = kid;
        tab.appendChild(rankBubble);
        tab.appendChild(nameSpan);
        tab.onclick = () => {
          currentKid = kid;
          renderTabs();
          renderTable();
        };
        tabsDiv.appendChild(tab);
      });
    }

    function renderTable() {
      const table = document.getElementById("choreTable");
      table.innerHTML = "";

      // header row with days
      let headerRow = "<tr><th></th>";
      days.forEach((day, i) => {
        const isToday = new Date().getDay() === (i+1)%7;
        headerRow += `<th class="${isToday ? 'current-day':''}">${day}</th>`;
      });
      headerRow += "<th>Total</th></tr>";
      table.innerHTML += headerRow;

      // rows for chores
      chores.forEach(chore => {
        let row = `<tr><td class="icon">${chore.icon}</td>`;
        days.forEach((day, i) => {
          const val = data?.[currentKid]?.[chore.key]?.[i] || "";
          row += `<td contenteditable onblur="saveData('${currentKid}','${chore.key}',${i}, this.innerText)">${val}</td>`;
        });
        const total = (data?.[currentKid]?.[chore.key] || []).reduce((a,b) => a + (parseInt(b)||0),0);
        row += `<td>${total}</td></tr>`;
        table.innerHTML += row;
      });
    }

    function saveData(kid, chore, dayIndex, value) {
      if (!data[kid]) data[kid] = {};
      if (!data[kid][chore]) data[kid][chore] = [];
      data[kid][chore][dayIndex] = value;

      db.collection("chores").doc(kid).set(data[kid]);
    }

    function loadData() {
      kids.forEach(kid => {
        db.collection("chores").doc(kid).onSnapshot(doc => {
          if (doc.exists) {
            data[kid] = doc.data();
            if (kid === currentKid) renderTable();
            updateRanks();
          }
        });
      });
    }

    function updateRanks() {
      const totals = kids.map(kid => {
        let total = 0;
        for (const choreKey in data[kid]) {
          total += (data[kid][choreKey]||[]).reduce((a,b) => a+(parseInt(b)||0),0);
        }
        return { kid, total };
      }).sort((a,b)=>b.total-a.total);

      kids.forEach((kid, i) => {
        const tab = document.querySelectorAll(".tab")[kids.indexOf(kid)];
        const bubble = tab.querySelector(".rank-bubble");
        const rank = totals.findIndex(t => t.kid === kid)+1;
        bubble.textContent = rank;
      });
    }

    renderTabs();
    renderTable();
    loadData();
  </script>
</body>
</html>
